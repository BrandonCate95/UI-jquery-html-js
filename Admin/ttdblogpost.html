<!DOCTYPE html>
<html>
<head>

<title>Dynamic Form</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://rawcdn.githack.com/eligrey/FileSaver.js/master/FileSaver.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/jquery.validation/1.16.0/additional-methods.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.154.0.min.js"></script>
  
<script language="javascript"> 
//adds post form to be filled out
var postNum = 1;
function add_post()
{

	//tabbing indicates what elements are inside what other elements for easier viewing
	var rowContainer = document.createElement("div");
	rowContainer.id = "row" + postNum;
	rowContainer.className = "row container-fluid";
	
		var div1 = document.createElement("div");
		div1.id = "left" + postNum;
		div1.className = "col-sm-2 post";
		
		var div2 = document.createElement("div");
		div2.id = "post" + postNum;
		div2.className = "col-sm-8 post";
	
			var pic = document.createElement("div");
			pic.className = "post pic";
			pic.style.backgroundImage = "url('#')";
			pic.title = "Click to Add Picture";
			pic.id = "pic" + postNum;
	
				var p = document.createElement("p");
				p.innerHTML = "Add Picture";
				p.className = "picText";
				p.id = "picText" + postNum;
	
				var picForm = document.createElement("form");
				picForm.id = "picForm" + postNum;
				picForm.className = "picForm";
				
					var picInput = document.createElement("input");
					picInput.type = "file";
					picInput.id = "picInput" + postNum;
					picInput.className = "picInput";
					
					var img = document.createElement("img");
					img.id = "img" + postNum;
					img.src = "#";
					img.className = "postImg";
	
			var desc = document.createElement("div");
			desc.className = "post desc";
			desc.id = "desc" + postNum;
	
				var descForm = document.createElement("form");
				descForm.id = "descForm" + postNum;
				descForm.className = "descForm";
				
					var title = document.createElement("input");
					title.type = "text";
					title.placeholder = "Title here...";
					title.className = "title input top";
					title.id = "title" + postNum;
					
					var price = document.createElement("input");
					price.type = "text";
					price.placeholder = "Price...";
					price.className = "price top";
					price.id = "price" + postNum;
					
					var info = document.createElement("textarea");
					info.placeholder = "Description and info here...";
					info.className = "info input";
					info.id = "info" + postNum;
					
					var link = document.createElement("input");
					link.type = "text";
					link.placeholder = "Link to website here...";
					link.className = "link input";
					link.id = "link" + postNum;
					
					var loc = document.createElement("i");
					loc.className = "fa fa-map-marker fa-fw fa-lg location";
					loc.setAttribute("aria-hidden", "true");
					loc.id = "location" + postNum;
					
						var locLink = document.createElement("input");
						locLink.type = "field";
						locLink.name = "field";
						locLink.className = "locationLink hidden";
						locLink.placeholder = "Location Link...";
						locLink.id = "locationLink" + postNum;
						
						var locLinkArrow = document.createElement("div");
						locLinkArrow.className = "arrow hidden";
						locLinkArrow.id = "locationLinkArrow" + postNum;
	
				//additional info section very liable to change with additional or removal of certain sections
				var addInfo = document.createElement("div");
				addInfo.className = "additionalInfo";
				addInfo.id = "additionalInfo" + postNum;
				
					var addForm = document.createElement("form");
					addForm.className = "additionalForm";
					addForm.id = "additionalForm" + postNum;
					
						var tags = document.createElement("input");
						tags.type = "text";
						tags.className = "tags addFormInput";
						tags.placeholder = "Comma seperated tags...";
						tags.name = "tags" + postNum;
						tags.id = "tags" + postNum;
						
						var email = document.createElement("input");
						email.type = "text";
						email.className = "email addFormInput";
						email.placeholder = "Valid email...";
						email.name = "email" + postNum;
						email.id = "email" + postNum;
						
						var busName = document.createElement("input");
						busName.type = "text";
						busName.className = "businessName addFormInput";
						busName.placeholder = "Legal Name of business...";
						busName.name = "businessName" + postNum;
						busName.id = "businessName" + postNum;
						
						var rating = document.createElement("input");
						rating.type = "text";
						rating.className = "rating addFormInput";
						rating.placeholder = "rating 0-5...";
						rating.name = "rating" + postNum;
						rating.id = "rating" + postNum;
						
		var div3 = document.createElement("div");
		div3.id = "right" + postNum;
		div3.className = "col-sm-2 post";
		
			var add = document.createElement("input");
			add.type = "button";
			add.name = "add" + postNum;
			add.id = "add" + postNum;
			add.className = "add";
			add.value = "Add Post";
	
	//BEGIN DIV2 APPENDS
	//additional info section layout
	addInfo.append("Tags: ");
	addInfo.append(document.createElement("br"));
	addInfo.append(tags);
	addInfo.append(document.createElement("br"));
	addInfo.append("Email: ");
	addInfo.append(document.createElement("br"));
	addInfo.append(email);
	addInfo.append(document.createElement("br"));
	addInfo.append("Business Name: ");
	addInfo.append(document.createElement("br"));
	addInfo.append(busName);
	addInfo.append(document.createElement("br"));
	addInfo.append("Rating: ");
	addInfo.append(document.createElement("br"));
	addInfo.append(rating);
	
	
	picForm.append(picInput);
	picForm.append(img);
	
	document.getElementById("blog_post").append(picForm);
	
	pic.append(p);
	
	div2.append(pic);
	
	
	loc.append(locLinkArrow);
	
	descForm.append(locLink);
	descForm.append(title);
	descForm.append(price);
	descForm.append(info);
	descForm.append(link);
	descForm.append(loc);

	desc.append(descForm);
	
	div2.append(desc);
	
	div2.append(addInfo);
	//END DIV2 APPENDS
	
	//BEGIN DIV3 APPENDS
	div3.append(add);
	
	rowContainer.append(div1);
	rowContainer.append(div2);
	rowContainer.append(div3);
	
	document.getElementById("blog_post").append(rowContainer);
	
	postNum++;
}

function readURL(num){
    var file = document.getElementById("picInput" + num).files[0];
	
    var reader = new FileReader();
    reader.onloadend = function(){
		
        document.getElementById('pic' + num).style.backgroundImage = "url(" + reader.result + ")";
		document.getElementById('picText' + num).className += " hidden";
        
    }	
    if(file){
        reader.readAsDataURL(file);
    }else{
    }
}

$(document).on("click", ".pic", function(){
	var num = this.id[this.id.length-1];
	uploadFile(num);
});

function uploadFile(num){

	document.getElementById("picInput" + num).click();
	$(document).on("change", "#picInput" + num, function(){
		readURL(num);
	});
}

$(function() {
  $(document).on("click", ".location", function(){
	var num = this.id[this.id.length-1];
	if(this.id[0] == "s")//for search result case
	{
		var el1 = document.getElementById("searchLocationLink" + num);
		var el2 = document.getElementById("searchLocationLinkArrow" + num);
	}else //for posting case
	{
		var el1 = document.getElementById("locationLink" + num);
		var el2 = document.getElementById("locationLinkArrow" + num);
	}

    if($(el1).hasClass('visible')) {
	  el1.classList.remove("visible");
	  el1.className += " hidden";
	  
	  el2.classList.remove("visible");
	  el2.className += " hidden";
    } else {
	  el1.classList.remove("hidden");
	  el1.className += " visible";
	  
	  el2.classList.remove("hidden");
	  el2.className += " visible";
	  
    }
    return false;
  });

});

AWS.config.update({
  region: "us-west-1",
  //endpoint: 'search-ttd-domain-test2-gsolgnte4fhaxqyyhm7cy6mgje.us-west-1.cloudsearch.amazonaws.com',
  // accessKeyId default can be used while using the downloadable version of DynamoDB. 
  // For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  accessKeyId: "AKIAIVI35QVTSEP2QXTQ",
  // secretAccessKey default can be used while using the downloadable version of DynamoDB. 
  // For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  secretAccessKey: "PQPCrBxwOoTIS907CdRbOOhy2D6ZMAkFVv4iciee"
});

var S3 = new AWS.S3({params: {Bucket: 'ttd-service-image-storage'}});
var dynamodb = new AWS.DynamoDB();
var docClient = new AWS.DynamoDB.DocumentClient();

$(function() {
	$(document).on("click", ".add", function(){
  
		var num = this.id[this.id.length-1];
		
		//first upload img to s3 for later retrival
		var imgFile = document.getElementById("picInput" + num).files[0];
		
		var params3 = {
			Key: "ttd/" + imgFile.name,
			ContentType: imgFile.type,
			Body: imgFile,
			ACL: 'public-read'
		};

  // Upload the file to s3
		S3.upload(params3, function(err, data) {
			if (err) {
				alert(err);
			} else {
				//alert("Image uploaded to s3 successfully!");
			}
		});
		
		//var location = document.getElementById("locationLink" + num).value;
		var title = document.getElementById("title" + num).value;
		//var price = document.getElementById("price" + num).value;
		//var description = document.getElementById("info" + num).value;
		//var link = document.getElementById("link" + num).value;
		//var tags = document.getElementById("tags" + num).value;
		//var email = document.getElementById("email" + num).value;
		//var businessName = document.getElementById("businessName" + num).value;
		
		postDynamo(num);
		
		//Gets search volume and numeric categories (look up at google for names) to add to dynamoDB
		//returnVolumeAndCategories(num, title)// => console.log("HELLLO")); //this is just the temporary search keyword -> could use title, tags, combination of both, get related search queries as well this is just temporary (probably)
		//ended here as we need to wait for response data before posting to dynamoDB
		

		
		//var params = {
		//	TableName : "ttdTest1",
		//	Item:{
		//		"title": title,
		//		"description": description,
				
		//		"img_path":"https://s3-us-west-1.amazonaws.com/ttd-service-image-storage/ttd/" + imgFile.name,
				
		//		"location": location,
		//		"price": price,
		//		"link": link,
		//		"tags": tags,
		//		"email": email,
		//		"businessname": businessName
			
		//	}
		//};
		
		//docClient.put(params, function(err, data) {
		//	if (err) {
		//		document.getElementById('textarea').innerHTML = "Unable to add item: " + "\n" + JSON.stringify(err, undefined, 2);
		///	}else {
		//		document.getElementById('textarea').innerHTML = "PutItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2);
		//	}
		//});
    });
		
});

function postDynamo(num)
{
	
	var imgFile = document.getElementById("picInput" + num).files[0];
	var location = document.getElementById("locationLink" + num).value;
	var title = document.getElementById("title" + num).value;
	var price = document.getElementById("price" + num).value;
	var description = document.getElementById("info" + num).value;
	var link = document.getElementById("link" + num).value;
	var tags = document.getElementById("tags" + num).value;
	var email = document.getElementById("email" + num).value;
	var businessName = document.getElementById("businessName" + num).value;
	var rating = parseInt(document.getElementById("rating" + num).value); //change to parse double when feel like
	
	//var searchVolume = parseInt(googleObj["SearchVolume"]);
	
	//var categories = googleObj["CategoryIds"]; //this is put in dynamo as a List->number which is not indexable in cloudsearch so might consider reworking somehow, but can do later

	var params = {
		TableName : "ttdTest1",
		Item:{
			"title": title,
			"description": description,
				
			"img_path":"https://s3-us-west-1.amazonaws.com/ttd-service-image-storage/ttd/" + imgFile.name,
				
			"location": location,
			"price": price,
			"link": link,
			"tags": tags,
			"email": email,
			"businessname": businessName,
			"ratingnum": rating,
			
			//"searchvolume": searchVolume,
			//"categoryids": categories
			
		}
	};
		
	docClient.put(params, function(err, data) {
		if (err) {
			document.getElementById('textarea').innerHTML = "Unable to add item: " + "\n" + JSON.stringify(err, undefined, 2);
		}else {
			document.getElementById('textarea').innerHTML = "PutItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2);
		}
	});
}


function eachRecursive(obj)//gets each post in an object to easily display in format
{
    for (var k in obj)
    {
        if (typeof obj[k] == "object" && obj[k] !== null)
            eachRecursive(obj[k]);
		else
			console.log(obj[k]);//can change this to a print if need be
    }
	return objArray;
}

$(function() {
	$(document).on("click", "#Search", function(){

		var http = new XMLHttpRequest();
		
		var query = document.getElementById("searchText").value;
		
		var formData = new FormData();
		formData.append("URL","http://search-ttd-domain-test2-gsolgnte4fhaxqyyhm7cy6mgje.us-west-1.cloudsearch.amazonaws.com/2013-01-01/search?q=" + query + "&return=title,description,link,location,price,img_path");
		
		http.open("POST", "http://localhost/UI/info.php", true);
		http.send(formData);

		http.onreadystatechange = function() {//Call a function when the state changes.
			if(http.readyState == 4 && http.status == 200) {
				var JSONString = http.responseText;
				var JSONObject = JSON.parse(JSON.parse(JSONString)); //There are two parses here as the first strips outer quotes and forward slashes while the second converts now readable JSON string into JSON object
				document.getElementById("textarea").innerHTML = JSON.stringify(JSONObject["hits"]["hit"]);
				
				formatData(JSONObject["hits"]["hit"]);
			}
		}		
	});
});

function formatData(obj)//basically add_post w/o additional info section and obj data inside thier respective element values
{

	document.getElementById("search_results").innerHTML = "";
	
	for(var k in obj)
	{
	//tabbing indicates what elements are inside what other elements for easier viewing
	console.log(obj[k]["fields"]);
	var rowContainer = document.createElement("div");
	rowContainer.id = "searchRow" + k;
	rowContainer.className = "row container-fluid";
	
		var div1 = document.createElement("div");
		div1.id = "searchLeft" + k;
		div1.className = "col-sm-2 searchResult";
		
		var div2 = document.createElement("div");
		div2.id = "searchPost" + k;
		div2.className = "col-sm-8 searchResult";
	
			var pic = document.createElement("div");
			pic.className = "searchResult searchPic";
			pic.style.backgroundImage = "url('" + obj[k]["fields"]["img_path"] + "')";
			pic.id = "searchPic" + k;	
	
				//leaving as may use for img element is better setting background of pic element
				
				//var picForm = document.createElement("form");
				//picForm.id = "picForm" + searchNum;
				//picForm.className = "picForm";
				
					//var picInput = document.createElement("input");
					//picInput.type = "file";
					//picInput.id = "picInput" + searchNum;
					//picInput.className = "picInput";
					
					//var img = document.createElement("img");
					//img.id = "img" + searchNum;
					//img.src = "#";
					//img.className = "postImg";
	
			var desc = document.createElement("div");
			desc.className = "searchResult searchDesc";
			desc.id = "searchDesc" + k;
				
					var title = document.createElement("div");
					title.innerHTML = obj[k]["fields"]["title"];
					title.className = "title input top";
					title.id = "searchTitle" + k;
					
					var price = document.createElement("div");
					price.innerHTML = obj[k]["fields"]["price"];
					price.className = "price top";
					price.id = "searchPrice" + k;
					
					var info = document.createElement("div");
					info.innerHTML = obj[k]["fields"]["description"];
					info.className = "info input";
					info.id = "searchInfo" + k;
					
					var link = document.createElement("div");
					link.innerHTML = obj[k]["fields"]["link"];
					link.className = "searchLink input";
					link.id = "searchLink" + k;
					
					var loc = document.createElement("i");
					loc.className = "fa fa-map-marker fa-fw fa-lg location";
					loc.setAttribute("aria-hidden", "true");
					loc.id = "searchLocation" + k;
					
						var locLink = document.createElement("div");
						locLink.className = "searchLocationLink hidden";
						locLink.innerHTML = obj[k]["fields"]["location"];
						locLink.id = "searchLocationLink" + k;
						
						var locLinkArrow = document.createElement("div");
						locLinkArrow.className = "arrow hidden";
						locLinkArrow.id = "searchLocationLinkArrow" + k;
						
		var div3 = document.createElement("div");
		div3.id = "searchRight" + k;
		div3.className = "col-sm-2 searchResult";
		
		
	//BEGIN DIV2 APPENDS
	
	div2.append(pic);
	
	
	loc.append(locLinkArrow);
	
	desc.append(locLink);
	desc.append(title);
	desc.append(price);
	desc.append(info);
	desc.append(link);
	desc.append(loc);
	
	div2.append(desc);

	//END DIV2 APPENDS
	
	//BEGIN DIV3 APPENDS
	
	rowContainer.append(div1);
	rowContainer.append(div2);
	rowContainer.append(div3);
	
	document.getElementById("search_results").append(rowContainer);
		
	
	}
	
	
	
}

function returnVolumeAndCategories(num, keywordList)
{

	var http = new XMLHttpRequest();
		
	var formData = new FormData();
	formData.append("keywords", keywordList);
		
	http.open("POST", "http://localhost/googleads-php-lib/examples/AdWords/v201710/Optimization/GetKeywordIdeas.php", true);
	http.send(formData);

	http.onreadystatechange = function() {//Call a function when the state changes.
		if(http.readyState == 4 && http.status == 200) {
			console.log("State Change");
			var JSONString = http.responseText;
			console.log(JSONString);
			var JSONObject = JSON.parse(JSON.parse(JSONString)); //There are two parses here as the first strips outer quotes and forward slashes while the second converts now readable JSON string into JSON object
			//document.getElementById("textarea").innerHTML = JSONString;
			document.getElementById("textarea").innerHTML += JSONObject;
			console.log(JSONObject);
			postDynamo(num, JSONObject);
		}
	}
}

</script>

<style>

.add
{
	position:absolute;
	margin:0 25% 0 25%;
	top:186px;
	text-align:center;
}


.post
{
	display:inline;
	padding:0px;
	height:440px;
}

.searchResult
{
	display:inline;
	padding:0px;
	height:220px;
}

.desc
{
	position:absolute;
	width:75%;
	left:25%;
	height:200px;
	border:1px solid;
}

.searchDesc
{
	position:absolute;
	width:75%;
	left:25%;
	height:200px;
	padding:10px;
	border:1px solid;
}

.pic
{
	position:absolute;
	width:25%;
	background-repeat:no-repeat;
	background-size:100% 100%;
	cursor:pointer;
	height:200px;
	border:1px solid;
}

.searchPic
{
	position:absolute;
	width:25%;
	background-size:100%;
	height:200px;
	border:1px solid;
}

.additionalInfo
{
	position:absolute;
	top:200px;
	width:100%;
	height:230px;
	border:1px solid;
	padding-left:5px;
}

.addFormInput
{
	margin-left:15px;
}

.postImg
{
	width:100%;
}

.picForm
{
	position:absolute;
	height:100%;
	visibility:hidden;
}

.picInput
{
	opacity:0;
	width:100%;
	height:100%;
}

.picText
{

	position: absolute;
    left: 0;
    top: 88px;
    width: 100%;
    text-align: center;
	font-weight:bold;
	opacity:0.5;
	
}

.container-fluid
{
	padding:0px;
	margin:0px;
}

.hidden
{
	opacity:0;
}

.visible
{
	opacity:1;
}

.descForm
{
	height:100%;
	padding:10px;
}

.title
{
	display:inline-block;
	height:25%;
	width:75%;
	font-size:34px;
	font-weight:bold;
}

.price
{
	float:right;
	height:25%;
	width:24%;
	text-align:center;
	background-color:#eeeeee;
	border-radius:15px;
	border-color:grey;
	border-style:outset;
	font-size:26px;
}

.info
{
	height:56%;
	width:100%;
	padding:2px;
}

.link
{
	display:inline-block;
	color:blue;
	height:15%;
	width:90%;
}

.searchLink
{
	display:inline-block;
	margin-top:5px;
	color:blue;
	height:15%;
	width:90%;
}

.input
{
	border:1px solid;
	border-radius:4px;
	border-color:#efefef;
}


.location
{
	position:relative;
	width:10%;
	height:15%;
}

.locationLink
{
	position:absolute;
	width:200px;
	bottom:22%;
	left:93%;
	margin-left:-30px;
	border-radius:5px;
	border-width:3px;
}

.searchLocationLink
{
	position:absolute;
	width:200px;
	bottom:22%;
	left:93%;
	margin-left:-30px;
	padding-left:3px;
	border-radius:5px;
	border:2px solid grey;
	background-color:white;
}

.arrow
{
	position:relative;
	width: 5px; 
	height: 15px; 
	bottom:30px;
	border-left: 10px solid transparent;
	border-right: 10px solid transparent;
	border-top: 10px solid grey;
	
	margin:auto;
	padding: 0 0px 0 0px;
}

.additionalInfo
{
	float:bottom;
}


</style>
  
</head>
<body>

<h1>Base Webpage</h1>

<form id="addPost">
	<input type="button" value="Add ttd post" style="font-weight:bold;" onclick="add_post()">
</form>

<div id="blog_post">

</div>

<input type="text" id="searchText" name="searchText" placeholder="query...">
<input type="button" id="Search" value="Search">
<br>
<textarea readonly id= "textarea" placeholder="Relevant data from list, describe, and create table will show up here" style="width:600px; height:400px"></textarea>


<div id="search_results">

</div>


</body>

</html>